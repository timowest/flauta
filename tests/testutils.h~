#include <vector>

#include <sndfile.hh>
#include <iostream>
#include <fstream>
#include <cmath>
#include <stdio.h>
#include <math.h>
#include <cstdlib>

void convert_line_to_floats(char* line, float* floats) {
    char *pch = strtok(line, " ");
    int counter = 0;
    for (; pch != NULL; floats++, counter++) {
        *floats = atof(pch);
        pch = strtok(NULL, " ");
    }
    // fill rest of array with last value
    float last_value = *(floats-1);
    for (int i = counter; i < SIZE; i++, floats++) {
        *floats = last_value;
    }
}

void convert_floats_to_out(float* floats, ofstream* out) {
    for (int i = 0; i < SIZE; i++) {
        (*out) << floats[i] << " ";
    }
    (*out) << "\n\n";
}

void test(dsp* processor, const char* in_file, const char* out_file, int in_count, int_out_count) {
    float in1[SIZE],  in2[SIZE],  in3[SIZE];
    float out1[SIZE], out2[SIZE], out3[SIZE];
    float *inputs[] = {in1, in2, in3};
    float *outputs[] = {out1, out2, out3};

    char line[2048];

    ifstream in(in_file);
    in.getline(line, 2048);
    convert_line_to_floats(line, in1);
    if (in_count > 1) {
        in.getline(line, 2048);
        convert_line_to_floats(line, in2);
    }
    if (in_count > 2) {
        in.getline(line, 2048);
        convert_line_to_floats(line, in3);
    }
    in.close();
    processor->init(44100);
    processor->compute(SIZE, inputs, outputs);

    ofstream out(out_file);
    convert_floats_to_out(out1, &out);
    if (out_count > 1) convert_floats_to_out(out2, &out);
    it (out_count > 2) convert_floats_to_out(out3, &out);
    out.close();
}
